<%# Récupération du des fonctions %>
<% content_for(:attachments_js) do %>
    <%= javascript_include_tag "attachments" %>
<% end %>

<%= form_for(@email, :url => {:action => "update" }, :html => { :class => "well "}) do |f| %>
  

  <div class="row row-fluid">
    <div class="field full">
      <div class="span2">Envoyé à : </div>
      <input type="text" class="field left" value=<%= @email.to.join(' ; ') %> readonly/>
    </div>
  </div>

<%#Affichage du champ compte %>
<div class="row row-fluid">
  <div class="field full">
    <div class="span2">
	<%= f.label('account-search', t('app.model.Account') + t('app.fields.colon')) %></div>
    <% company = nil
	if (!@email.arbitrary_contact.blank?)
	    contact = Contact.find(@email.arbitrary_contact.id)
	    if (!contact.account_id.blank?)
		    company = Account.find(contact.account_id)
		end
	elsif (!@email.arbitrary_account.blank?) 
	    company = @email.arbitrary_account
	end %>
	<% if company.blank? %>
			<%= text_field_tag(nil, company, { :class => 'typeahead-account-search', :type => 'search', :autocomplete => 'off', 'data-field' => 'account_id', :placeholder => 'Rechercher' }) %>
	<% else %>
		<%= text_field_tag(nil, company.company, { :class => 'typeahead-account-search', :type => 'search', :autocomplete => 'off', 'data-field' => 'account_id', :placeholder => 'Rechercher' }) %>
	<% end %>
	    <%= f.text_field :account_id, { :style => 'display: none; visible: none;', :id => 'account_id' } %>
		<%= image_tag('/assets/icons/loading.gif', :alt => 'Please wait...', :class => 'loading hidden') %>
    </div>
</div>

<%#Affichage du champ contact %>
<div class="row row-fluid">
	<div class="field full">
		<div class="span2">
			Contact :
		</div>
		<div class="field">
        	<% if !company.nil? %>
          	<%= collection_select :email, :contact_id, Contact.where(:account_id => company.id).order(:surname), :id, :full_name, {:include_blank => true }, { :id => 'contact_id' } %>
          <%= image_tag('/assets/icons/loading.gif', :alt => 'Please wait...', :class => 'loading hidden') %>
        <% else %>
          <%= collection_select :email, :contact_id, Contact.where(:account_id => 0), :id, :full_name, {:include_blank => true}, { :id => 'contact_id' } %>
          <%= image_tag('/assets/icons/loading.gif', :alt => 'Please wait...', :class => 'loading hidden') %>
        <% end %>
		</div>
	</div>
</div>

<%#Affichage du champ objet %>
<div class="row row-fluid">
	<div class="field full">
		<div class="span2">
			Objet :
		</div>
		<%= f.text_field :object %><span class="req"/>
	</div>
</div>



<%#Affichage du champ contenu %>
<div class="row row-fluid">
	<div class="field full">
		<div class="span2">
			Contenu :
		</div>
		<%= f.text_area :content, :rows => "5", :style => 'width: 50%;', :required => 'required' %><span class="req" />
	</div>
</div>

<%# Affichage des pièces jointes si il y en a %>
<% if !@email.email_attachments.blank? %>
    <div class="row row-fluid">
        
            <div class="span2"></div><%= pluralize(@email.email_attachments.length,'pièce-jointe', 'pièces-jointes') %> actuellement :
        
    </div>
	<table>
    <% @email.email_attachments.each do |attach| %>
		<tr>
            	<div class="field full">
                	<td><div class="span2"></div></td>
			<td><%= link_to image_tag('glyphicons/glyphicons_062_attach.png') + ' ' + attach.attach_file_name , attach.attach.url, :target => '_blank' %></td>
		<td><%= link_to '<i class="icon-trash"></i>'.html_safe, attachment_path(attach.id, :type => "email"), :confirm => 'Confirmer la suppression ?', :method => :delete, :title => "Supprimer" %></td>
		</tr>
		</div>
    <% end %>
</table><br/>
<% end %>

<%#Affichage du champ d'ajout de pièce jointe %>
<div class="row row-fluid">
	<div class="field full">
      <div class="span2"><%= f.label :email_attachments_attach, "Pièce-jointe : ", :class => 'top' %> </div>
      <div id="new_attachments">
        <%= f.file_field('email-attachments_attach', name: "email[email_attachments_attributes][][attach]") %>
      </div>
      <input type="hidden" id="attachment_id" value="1">
	</div>
</div>

    <%#Affichage du bouton d'ajout de pièce-jointe %>
    <div class="row row-fluid">
	    <div class="field full">
		    <div class="span2"></div>
		    <input type="image" src="/assets/glyphicons/glyphicons_190_circle_plus.png" class="btn" title="Ajouter une pièce jointe" onClick="addFileField('email'); return false;">
			
	    </div>
    </div>

<%#Affichage du champ date %>
<div class="row row-fluid">
	
	<div class="span2" style="text-align: right; padding-right: 10px;">
		Date :  
	</div>
		<strong>
		<%# Affichage de la date complète en gras, non modifiable %>
			<%= @email.send_at.strftime("%d/%m/%Y à %H:%M") %>
		</strong>
</div>
<%= f.hidden_field :id %>
<div class="row row-fluid">
<hr><%= if !@email.id.nil? then f.submit "Modifier l'email", :class =>"btn btn-primary" end %><hr/>
</div>
<% end %>

<%= javascript_include_tag "//www.google.com/jsapi", "chartkick" %>

<div class="container-fluid" style="margin-top: 1em;">
     <div class="well">
       <div class="row-fluid">
         <div class="span9">
           <h1><%= t('title.reporting')%></h1>
         </div>
       </div>
     </div>
</div>



<div id="reporting_value" class="container-fluid">
    <%= form_tag(reporting_path, method: :GET) do %>
        <div class="row row-fluid">
               <div class="small-date">
                    <p><%= label_tag :start_at, "Début :", :class => 'top' %><%= text_field_tag :start_at, @start_at.to_date.strftime("%d/%m/%Y"), class: "event_date", data: { provide: "datepicker" } %></p>
               </div>
               <div class="small-date">
                    <p><%= label_tag :end_at, "Fin :", :class => 'top' %><%= text_field_tag :end_at, @end_at.to_date.strftime("%d/%m/%Y"), class: "event_date", data: { provide: "datepicker" } %></p>
               </div>
               <%# Le typeahead et la recherche automatique des contacts associés sont gérés par nav-search-bar.js %>
               <div class="">
                    <%= label_tag :by_account_id, t('app.fields.collegue') + " :", :class => "top" %>
                    <%= select_tag "user_id", options_from_collection_for_select(User.all_reals, :id, :full_name, @user_id), { :include_blank => "All", :class =>"filter_statut" } %>
               </div>
               <div>
                    <%= submit_tag t('app.actions.filter'), :class =>"btn "%>
               </div>
          </div>
   <% end %>
</div>




<!--Events-->
<div class="container-fluid">
<table class="table table-bordered table-striped table-hover">
  <thead>
    <tr>
      <th class="text-center"><%= link_to"#{t('app.model.Event').pluralize}".html_safe, events_path, :title => "#{t('app.model.Event').pluralize}".html_safe %> créés du <%= @start_at.to_date.strftime("%d/%m/%Y") %> au <%= @end_at.to_date.strftime("%d/%m/%Y") %></th>	
      <th class="text-center">Nombre</th>
      <th class="text-center">Plus ancien</th>
      <th class="text-center">Plus récent</th>
      <th class="text-center">Moy. journalière</th>
    </tr>
  </thead>
  <tbody>
     <% EventType.all.each do |event_type| %>
          <% if !(@events.by_event_type_id(event_type.id).count == 0) %>
          <tr>
               <td class="text-center"><%= event_type.label %> <%= event_type.direction %></td>
               <td class="text-center"><%= @events.by_event_type_id(event_type.id).count %></td>
               <td class="text-center"><%= @events.by_event_type_id(event_type.id).blank? ? '-' : @events.by_event_type_id(event_type.id).order("created_at ASC").first.created_at.strftime("%d/%m/%Y - %H:%M") %></td>
               <td class="text-center"><%= @events.by_event_type_id(event_type.id).blank? ? '-' : @events.by_event_type_id(event_type.id).order("created_at DESC").first.created_at.strftime("%d/%m/%Y - %H:%M") %></td>
               <td class="text-center"><%= number_with_precision( (@events.by_event_type_id(event_type.id).count / (@end_at.to_date - @start_at.to_date + 1)), :precision => 2) %></td>
          </tr>
          <% end %>
     <% end %>
     <tr>
          <td class="text-center"><strong>Total</strong></td>
          <td class="text-center"><%= @events.count %></td>
          <td class="text-center"><%= @events.blank? ? '-' : @events.order("created_at ASC").first.created_at.strftime("%d/%m/%Y - %H:%M") %></td>
          <td class="text-center"><%= @events.blank? ? '-' : @events.order("created_at DESC").first.created_at.strftime("%d/%m/%Y - %H:%M") %></td>
          <td class="text-center"><%= number_with_precision( (@events.count / (@end_at.to_date - @start_at.to_date + 1)), :precision => 2) %></td>
     </tr>     
  </tbody>
</table>
     <div class="row-fluid">
          <div class="span8">
               <%= line_chart @events.group_by_day(:created_at).count %>
          </div>
          <div class="span4">
               <%= pie_chart @events.joins(:event_type).group("(event_types.label, event_types.direction)").count %>
          </div>
     </div>
</div>


<!--Tasks-->
<div class="container-fluid">
<table class="table table-bordered table-striped table-hover">
  <thead>
    <tr>
      <th class="text-center"><%= link_to"#{t('app.model.Task').pluralize}".html_safe, tasks_path, :title => "#{t('app.model.Task').pluralize}".html_safe %> créées du <%= @start_at.to_date.strftime("%d/%m/%Y") %> au <%= @end_at.to_date.strftime("%d/%m/%Y") %></th>	
      <th class="text-center">Nombre</th>
      <th class="text-center">Plus ancienne</th>
      <th class="text-center">Plus récente</th>
      <th class="text-center">Moy. journalière</th>
    </tr>
  </thead>
  <tbody>
     <% Task::STATUTS.each do |status| %>
          <% if !(@tasks.by_statut(status).count == 0) %>
          <tr>
               <td class="text-center"><%= status %></td>
               <td class="text-center"><%= @tasks.by_statut(status).count %></td>
               <td class="text-center"><%= @tasks.by_statut(status).blank? ? '-' : @tasks.by_statut(status).order("created_at ASC").first.created_at.strftime("%d/%m/%Y - %H:%M") %></td>
               <td class="text-center"><%= @tasks.by_statut(status).blank? ? '-' : @tasks.by_statut(status).order("created_at DESC").first.created_at.strftime("%d/%m/%Y - %H:%M") %></td>
               <td class="text-center"><%= number_with_precision( (@tasks.by_statut(status).count / (@end_at.to_date - @start_at.to_date + 1)), :precision => 2) %></td>
          </tr>
          <% end %>
     <% end %>
     <tr>
          <td class="text-center"><strong>Total</strong></td>
          <td class="text-center"><%= @tasks.count %></td>
          <td class="text-center"><%= @tasks.blank? ? '-' : @tasks.order("created_at ASC").first.created_at.strftime("%d/%m/%Y - %H:%M") %></td>
          <td class="text-center"><%= @tasks.blank? ? '-' : @tasks.order("created_at DESC").first.created_at.strftime("%d/%m/%Y - %H:%M") %></td>
          <td class="text-center"><%= number_with_precision( (@tasks.count / (@end_at.to_date - @start_at.to_date + 1)), :precision => 2) %></td>
     </tr>     
  </tbody>
</table>
     <div class="row-fluid">
          <div class="span8">
               <%= line_chart @tasks.group_by_day(:created_at).count %>
          </div>
          <div class="span4">
               <%= pie_chart @tasks.group(:statut).count %>
          </div>
     </div>
</div>
